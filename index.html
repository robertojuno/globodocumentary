<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Globo con Miniature Video e Pallini Verdi (sprite)</title>
  <style>
    body { margin: 0; background: black; }
    canvas { display: block; }
  </style>
  <script src="https://unpkg.com/three@0.149.0/build/three.min.js"></script>
  <script src="https://unpkg.com/globe.gl"></script>
</head>
<body>
  <div id="globeViz" style="width: 100vw; height: 100vh;"></div>

  <script src="https://unpkg.com/topojson@3"></script>
  <script>
    const videos = [
      {
        lat: 43.8562586,
        lng: 18.41330763,
        title: 'Sarajevo',
        videoId: 'GqQKJHXoUD8',
        url: 'https://youtu.be/GqQKJHXoUD8?si=LWFZ9f0ckd681Trk'
      },
      {
        lat: 28.0026,
        lng: 86.8528,
        title: 'Everest Basecamp',
        videoId: 'q7_jPoJM-Jc',
        url: 'https://youtu.be/q7_jPoJM-Jc?si=x0bdF3F7mz2H5CY9'
      }
    ];

    const globe = Globe()(document.getElementById('globeViz'))
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-day.jpg')
      .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
      .showAtmosphere(true)
      .pointOfView({ lat: 20, lng: 0, altitude: 2 });

    // Carico confini paesi
    const worldAtlasUrl =
      'https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json';

    fetch(worldAtlasUrl)
      .then(res => res.json())
      .then(worldData => {
        const countries = topojson.feature(worldData, worldData.objects.countries).features;
        globe.polygonsData(countries)
          .polygonStrokeColor(() => 'white')
          .polygonAltitude(0.01)
          .polygonCapColor(() => 'rgba(255, 255, 255, 0.1)');
      });

    // Funzione per creare sprite da url immagine
    function createSprite(url) {
      const texture = new THREE.TextureLoader().load(url);
      const material = new THREE.SpriteMaterial({ map: texture, depthTest: false, sizeAttenuation: false });
      const sprite = new THREE.Sprite(material);
      sprite.scale.set(6, 4, 1); // dimensioni sprite (adatta a miniatura)
      return sprite;
    }

    // Aggiungo marker sprite al globo
    videos.forEach(video => {
      const sprite = createSprite(`https://img.youtube.com/vi/${video.videoId}/hqdefault.jpg`);
      // Posizione in coordinate XYZ (raggio 1 + altezza)
      const radius = 1.01;
      const phi = (90 - video.lat) * (Math.PI / 180);
      const theta = (video.lng + 180) * (Math.PI / 180);

      sprite.position.set(
        radius * Math.sin(phi) * Math.cos(theta),
        radius * Math.cos(phi),
        radius * Math.sin(phi) * Math.sin(theta)
      );

      // Salvo url nel sprite per aprire video
      sprite.userData = { url: video.url };

      globe.scene().add(sprite);
    });

    // Gestisco click: controllo se clicco su sprite
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    function onClick(event) {
      const rect = globe.renderer().domElement.getBoundingClientRect();
      mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

      raycaster.setFromCamera(mouse, globe.camera());

      const intersects = raycaster.intersectObjects(globe.scene().children);

      for (let i = 0; i < intersects.length; i++) {
        const obj = intersects[i].object;
        if (obj.userData && obj.userData.url) {
          window.open(obj.userData.url, '_blank');
          break;
        }
      }
    }

    globe.renderer().domElement.addEventListener('click', onClick);

  </script>
</body>
</html>
